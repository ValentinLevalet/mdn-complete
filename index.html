<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width">

<title>Test for IndexedDB Autosuggest</title>
<script src="scripts/jquery.js"></script>
<!-- <script src="scripts/support.js"></script> -->
<script src="scripts/jquery-ui-1.js"></script>
<script src="scripts/handlebars-1.js"></script>
<script src="scripts/data.js"></script>
<script src="scripts/action.js"></script>

<link href="styles/jquery-ui-1.css" rel="stylesheet">
<link href="styles/style.css" rel="stylesheet">
<script>

// https://developer.mozilla.org/en/IndexedDB/Using_IndexedDB
window.indexedDB = window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.msIndexedDB;
var IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction;
var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange;

var db;
var template;

$(document).ready(function() {
	console.log("Startup...");

   	//Create our template
   	var source   = $("#employeeTemplate").html();
		template = Handlebars.compile(source);


	var openRequest = indexedDB.open("employeesTest",1);

    //handle setup
    openRequest.onupgradeneeded = function(e) {

        console.log("running onupgradeneeded");
        var thisDb = e.target.result;

        //Create Employee
        if(!thisDb.objectStoreNames.contains("employee")) {
            console.log("I need to make the employee objectstore");
            var objectStore = thisDb.createObjectStore("employee", { keyPath: "id", autoIncrement:true });
            objectStore.createIndex("mot", "mot", { unique: false });
        }


    }

    openRequest.onsuccess = function(e) {
    	db = e.target.result;

    	db.onerror = function(e) {
    		alert("Sorry, an unforseen error was thrown.");
    		console.log("***ERROR***");
    		console.dir(e.target);
    	}

        handleSeed();

    }

});

function handleSeed() {
	/*
	This is how we handle the initial data seed. Normally this would be via AJAX
	*/
	db.transaction(["employee"], "readonly").objectStore("employee").count().onsuccess = function(e) {
		var count = e.target.result;
		if(count == 0 ) {
			console.log("Need to generate fake data - stand by please...");
			$("#status").text("Please stand by, loading in our initial data.");
			var done = 0;
			//Generate 1k people
            //var data = [{"col1":"value1","col2":"value1","col3":"value1"},{"col1":"value2","col2":"value2","col3":"value2"},{"col1":"value3","col2":"value3","col3":"value3"}];

			var trans = db.transaction(["employee"], "readwrite");
            var employees = trans.objectStore("employee");
            for (i = 0; i < data.length; i++) {
            resp = employees.put(data[i]);

                resp.onsuccess = function(e) {
                done++;
                if(done == 100) {
                  $("#champsSaisie").removeAttr("disabled");
                  $("#status").text("");
                  setupAutoComplete();
                } else if(done % 100 == 0) {
                  $("#status").text("Approximately "+Math.floor(done/10) +"% done.");
                }
              }

            }

			/*for(var i=0; i<100; i++) {
				var person = generateFakePerson();
				//Modify our data to add a searchable field
				person.searchkey = person.firstname.toLowerCase();
                                resp = employees.add(person);
				resp.onsuccess = function(e) {
					done++;
					if(done == 100) {
						$("#champsSaisie").removeAttr("disabled");
						$("#status").text("");
						setupAutoComplete();
					} else if(done % 100 == 0) {
						$("#status").text("Approximately "+Math.floor(done/10) +"% done.");
					}
				}
			}*/
            // recharger page
            
		} else {
			$("#champsSaisie").removeAttr("disabled");
			setupAutoComplete();
		}
	}
}

function setupAutoComplete() {

	//Create the autocomplete
	$("#champsSaisie").autocomplete({
		source: function( request, response ) {

			console.log("Going to look for "+request.term);

			//$("#displayEmployee").hide();

			var transaction = db.transaction(["employee"], "readonly");
			var result = [];

            //résultat limité à 7 mots
			transaction.oncomplete = function(event) {
				response(result.slice(0, 7));
			}

			//TODO: Handle the error and return to it jQuery UI
			var objectStore = transaction.objectStore("employee");

			//Credit: http://stackoverflow.com/a/8961462/52160
        	var range = IDBKeyRange.bound(request.term.toLowerCase(), request.term.toLowerCase() + "z");
          var index = objectStore.index("mot");

          index.openCursor(range).onsuccess = function(event) {
            var cursor = event.target.result;
            if(cursor) {
              result.push({value: cursor.value.mot,person: cursor.value});
              cursor.continue();
	        	}
	        };

		},
		minLength:2,
		select:function(event,ui) {
			$("#displayEmployee").show().html(template(ui.item.person));
            $("body").animate({ scrollTop: 0}, 600);
            $("#champsSaisie").blur();
		}
	});

}
</script>

<script id="employeeTemplate" type="text/x-handlerbars-template">
    <h1>{{mot}}</h1>
    <span class="example"><i>{{etym}}</i></span>
    <div>
        {{#lexeme}}

            <br>{{-pos}}.

                {{#defs}}

                <ol>
                    {{#each toplevel-def}}
                    <li>

                        {{gloss}}
                        {{#glossObject}}<i class="glossObject"> {{-domain}} {{-register}} {{-semantic}}</i>{{text}}</i>{{/glossObject}} 
                        <i><ul class="example">{{#each exampleArray}}<li>
                            {{this}}<br>
                            {{-reference}}
                            {{text}}</li>
                            {{/each}}</ul></i>
                        <i class="example">{{example}}</i>
                        {{#sublevel-def}}<ul><li>
                        {{#glossObject}}<i class="glossObject"> {{-reference}} {{-semantic}}</i>{{text}}{{/glossObject}}
                            {{gloss}}<br>
                        </li></ul>{{/sublevel-def}}

                    </li>
                    {{/each}}
                    {{toplevel-def.gloss}}
                </ol>

                {{/defs}}

                {{#syn}}<p>Synonyme(s)</p>
                    {{#each item}}
                        {{this}},
                    {{/each}}
                {{/syn}}

                {{#hyper}}<p>Hypernyme(s)</p>
                    {{item}}
                    {{#each item}}
                        {{this}},
                    {{/each}}
                {{/hyper}}

                {{#hypo}}<p>Hyponyme(s)</p>
                    {{#each item}}
                        {{this}},
                    {{/each}}
                {{/hypo}}

        {{/lexeme}}



    </div>

</script>

</head>

<body>

<form>
	 <input aria-haspopup="true" aria-autocomplete="list" role="textbox" autocomplete="off" class="ui-autocomplete-input" id="champsSaisie" autofocus type="search"><span id="status"></span>
    <a onclick="annuler();" id="btAnnuler">X</a>
</form>

<a onclick="cacheExemples();">Ex.</a>

<div id="displayEmployee"></div>



<ul style="z-index: 1; top: 0px; left: 0px; display: none;" aria-activedescendant="ui-active-menuitem" role="listbox" class="ui-autocomplete ui-menu ui-widget ui-widget-content ui-corner-all"></ul></body></html>

<a href="delete.html">Delete</a>